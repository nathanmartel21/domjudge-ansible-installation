# DOMjudge Judgehost role installation

<table>
  <tr>
    <td style="width: 100%; padding: 0; height: 120px;">
      <table style="width:100%; height:120px;"><tr><td style="vertical-align:middle;">
        <blockquote style="margin: 0;">
          This ansible role automates the <b>installation</b> of a DOMjudge <b>judgehost</b> on a remote machine, and connects it to an existing <b>domserver</b> using the DOMjudge API.
        </blockquote>
      </td></tr></table>
    </td>
    <td style="text-align: right; vertical-align: middle;">
      <img src="../docs/img/DOMjudgelogo.svg" alt="DOMjudge Logo" height="100">
    </td>
  </tr>
</table>

---

## Remote access requirements

> [!IMPORTANT]
> For the installation to work:
> - The user you connect with **must have sudo privileges** on the target machine.
> - You must have copied your SSH public key to the remote machine using:
>
> ```bash
> ssh-copy-id <user>@<host>
> ```
>
> > [!TIP]
> > Make sure you have configured both the SSH user and the SSH private key for ansible by setting these options in your `ansible.cfg` file:
> > ```ini
> > [defaults]
> > remote_user = <user>
> > private_key_file = /path/privatekey/...
> > ```
> > Replace `<user>` with your actual username and update the private key path accordingly.  
> > These should match the user and key you used for `ssh-copy-id`.

---

## Judgehost installation & connection

- **This role installs a DOMjudge judgehost and connects it to the domserver using the DOMjudge API.**

- > [!IMPORTANT]
  > The <b>domserver must already be installed and running</b> before running this judgehost playbook, because the judgehost will attempt to connect and register itself on the domserver via its API.
- The judgehost is identified as `judgehost_[hostname]` (where `[hostname]` is the name of the machine) when registered on the domserver.
- The judgehost password used for API authentication is the one randomly generated by DOMjudge during installation. This password is not modified.
- Each judgehost must have a **unique hostname** to avoid conflicts.

---

## Customizable variables

You can adjust the following variable when running the playbook:

```yaml
judgehost_cpu_core: 2
```

- **judgehost_cpu_core**:  
  Specifies which CPU core to assign for the judgehost daemon.  
  You can override this value at runtime, for example:

  ```bash
  ansible-playbook playbooks/judgehost.yml -e judgehost_cpu_core=3 --ask-become-pass
  ```

---

## Default installation

- By default, **CPU core 2** is used for the judgehost daemon.

---

## How judgehost registration works

- The playbook extracts the initial admin password from the domserver to register the judgehost via the API.
- Each judgehost is registered as a user with the role "judgehost" and a unique username of the form `judgehost_[hostname]`.
- The password for this judgehost user is the one generated and stored in `restapi.secret` on the judgehost. It is <b>not changed</b>.
- The judgehost will appear under the list of judgehosts in the domserver admin interface.

---

## Running the playbook

> [!NOTE]
> The inventory is already specified in the `ansible.cfg` file.

To launch the judgehost installation:

```bash
ansible-playbook playbooks/judgehost.yml --ask-become-pass
```

You can override variables (e.g., CPU core) as needed:

```bash
ansible-playbook playbooks/judgehost.yml -e judgehost_cpu_core=3 --ask-become-pass
```

---

## Notes

- **The domserver must be up and reachable before running this playbook.**
- This role does not modify demo/test data or passwords.
- The judgehost will be available and visible in the domserver's admin panel after a successful run.

---
